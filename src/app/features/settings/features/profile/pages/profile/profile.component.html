<div class="profile-container">
      <p-toast></p-toast>

      <div class="grid">
        <!-- Profile Header -->
        <div class="col-12">
          <p-card>
            <ng-template pTemplate="header">
              <div class="profile-header">
                <div class="profile-avatar-section">
                  <p-avatar
                    [image]="userProfileService.getPhotoUrl()"
                    [label]="userProfileService.getInitials()"
                    size="xlarge"
                    shape="circle"
                    class="profile-avatar">
                  </p-avatar>
                  <div class="avatar-actions">
                    <p-fileUpload
                      mode="basic"
                      name="photo"
                      accept="image/*"
                      [maxFileSize]="5000000"
                      [auto]="true"
                      (onUpload)="onPhotoUpload($event)"
                      chooseLabel="Alterar Foto"
                      chooseIcon="pi pi-camera"
                      class="photo-upload">
                    </p-fileUpload>
                  </div>
                </div>
                <div class="profile-info">
                  <h1 class="profile-name">{{ userProfileService.getFullName() }}</h1>
                  <p class="profile-username">{{ (currentUser$ | async )?.username }}</p>
                  <div class="profile-badges">
                    <p-badge
                      [value]="(currentUser$ | async)?.role?.name || ''"
                      severity="info">
                    </p-badge>
                    <p-badge
                      [value]="(currentUser$ | async)?.accountStatus || ''"
                      [severity]="getStatusSeverity((currentUser$ | async)?.accountStatus || '')">
                    </p-badge>
                  </div>
                </div>
              </div>
            </ng-template>
          </p-card>
        </div>

        <!-- Profile Form -->
        <div class="col-12 md:col-8">
          <p-card header="Informações do Perfil">
            <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
              <div class="grid">
                <div class="col-12 md:col-6">
                  <label for="firstName">Primeiro Nome</label>
                  <input
                    pInputText
                    id="firstName"
                    formControlName="firstName"
                    placeholder="Digite o primeiro nome"
                    [class.ng-invalid]="isFieldInvalid('firstName')">
                  <small
                    class="p-error"
                    *ngIf="isFieldInvalid('firstName')">
                    Primeiro nome é obrigatório
                  </small>
                </div>

                <div class="col-12 md:col-6">
                  <label for="lastName">Último Nome</label>
                  <input
                    pInputText
                    id="lastName"
                    formControlName="lastName"
                    placeholder="Digite o último nome"
                    [class.ng-invalid]="isFieldInvalid('lastName')">
                  <small
                    class="p-error"
                    *ngIf="isFieldInvalid('lastName')">
                    Último nome é obrigatório
                  </small>
                </div>

                <div class="col-12 md:col-6">
                  <label for="email">Email</label>
                  <input
                    pInputText
                    id="email"
                    formControlName="email"
                    placeholder="Digite o email"
                    type="email"
                    [class.ng-invalid]="isFieldInvalid('email')">
                  <small
                    class="p-error"
                    *ngIf="isFieldInvalid('email')">
                    Email é obrigatório
                  </small>
                </div>

                <div class="col-12 md:col-6">
                  <label for="phone">Telefone</label>
                  <input
                    pInputText
                    id="phone"
                    formControlName="phone"
                    placeholder="Digite o telefone">
                </div>

                <div class="col-12 md:col-6">
                    <label for="username">Nome de Usuário</label>
                  <label for="username">Nome de Usuário</label>
                  <input
                    pInputText
                    id="username"
                    formControlName="username"
                    placeholder="Digite o nome de usuário"
                    [class.ng-invalid]="isFieldInvalid('username')">
                  <small
                    class="p-error"
                    *ngIf="isFieldInvalid('username')">
                    Nome de usuário é obrigatório
                  </small>
                </div>

                <div class="col-12 md:col-6">
                  <label for="identificationNumber">Número de Identificação</label>
                  <input
                    pInputText
                    id="identificationNumber"
                    formControlName="identificationNumber"
                    placeholder="Digite o número de identificação">
                </div>

                <div class="col-12 md:col-6">
                  <label for="gender">Gênero</label>
                  <p-dropdown
                    id="gender"
                    formControlName="gender"
                    [options]="genderOptions"
                    placeholder="Selecione o gênero"
                    optionLabel="label"
                    optionValue="value">
                  </p-dropdown>
                </div>

                <div class="col-12 md:col-6">
                  <label for="birthdate">Data de Nascimento</label>
                  <p-calendar
                    id="birthdate"
                    formControlName="birthdate"
                    placeholder="Selecione a data de nascimento"
                    [showIcon]="true"
                    dateFormat="dd/mm/yy">
                  </p-calendar>
                </div>
              </div>

              <div class="form-actions">
                <p-button
                  type="submit"
                  label="Atualizar Perfil"
                  icon="pi pi-save"
                  [loading]="(loading$ | async) || false"
                  [disabled]="profileForm.invalid">
                </p-button>
                <p-button
                  type="button"
                  label="Resetar"
                  icon="pi pi-refresh"
                  severity="secondary"
                  (click)="resetForm()">
                </p-button>
              </div>
            </form>
          </p-card>
        </div>

        <!-- Account Information -->
        <div class="col-12 md:col-4">
          <p-card header="Informações da Conta">
            <div class="account-info">
              <div class="info-item">
                    <label>Status da Conta</label>
                <p-badge
                  [value]="(currentUser$ | async)?.accountStatus || ''"
                  [severity]="getStatusSeverity((currentUser$ | async)?.accountStatus || '')">
                </p-badge>
              </div>

              <div class="info-item">
                <label>Email Verificado</label>
                <p-badge
                  [value]="(currentUser$ | async)?.emailVerified ? 'Yes' : 'No'"
                  [severity]="(currentUser$ | async)?.emailVerified ? 'success' : 'warning'">
                </p-badge>
              </div>

              <div class="info-item">
                <label>Telefone Verificado</label>
                <p-badge
                  [value]="(currentUser$ | async)?.phoneVerified ? 'Yes' : 'No'"
                  [severity]="(currentUser$ | async)?.phoneVerified ? 'success' : 'warning'">
                </p-badge>
              </div>

              <div class="info-item">
                <label>Role</label>
                <span class="role-name">{{ (currentUser$ | async)?.role?.name || 'N/A' }}</span>
              </div>

              <div class="info-item">
                <label>Membro Desde</label>
                <span>{{ (currentUser$ | async)?.createdAt | date:'medium' }}</span>
              </div>
            </div>

            <p-divider></p-divider>

            <div class="account-actions">
              <p-button
                label="Alterar Senha"
                icon="pi pi-key"
                severity="secondary"
                (click)="showChangePasswordDialog = true">
              </p-button>
            </div>
          </p-card>
        </div>

        <!-- User Permissions -->
        <div class="col-12">
          <p-card header="Permissões do Usuário">
            <div class="permissions-list" *ngIf="(currentUser$ | async)?.allPermissions?.length; else noPermissions">
              <div class="permission-item" *ngFor="let perm of (currentUser$ | async)?.allPermissions">
                <p-badge [value]="perm.name" severity="info"></p-badge>
              </div>
            </div>
            <ng-template #noPermissions>
              <span>Nenhuma permissão atribuída.</span>
            </ng-template>
          </p-card>
        </div>
      </div>
    </div>
