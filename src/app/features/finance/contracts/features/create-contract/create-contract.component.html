<div class="grid">
    <div class="col-12">
        <div class="card">
            <h5>Criar Contrato</h5>
            <p>Criar um novo contrato para um aluno</p>

            <p-toast></p-toast>

            <form [formGroup]="contractForm" (ngSubmit)="onSubmit()">
                <div class="grid formgrid p-fluid">
                    <!-- Student Selection -->
                    <div class="field col-12 md:col-6">
                        <label for="student">Aluno *</label>
                        <p-dropdown id="student" formControlName="student" [options]="students" optionLabel="name"
                            placeholder="Selecione um aluno" [(ngModel)]="selectedStudent" [showClear]="true">
                            <ng-template pTemplate="item" let-student>
                                <div>
                                    <div>{{student.name}}</div>
                                    <div class="text-sm text-500">{{student.user.email}} - {{student.center.name}}</div>
                                </div>
                            </ng-template>
                        </p-dropdown>
                        <small *ngIf="contractForm.get('student')?.invalid && contractForm.get('student')?.touched"
                            class="p-error">
                            Aluno é obrigatório
                        </small>
                    </div>

                    <!-- Seller -->
                    <div class="field col-12 md:col-6">
                        <label for="sellerId">Vendedor *</label>
                        <p-dropdown id="sellerId" formControlName="sellerId" [options]="employees"
                            optionLabel="displayName" optionValue="id" placeholder="Selecione um vendedor"
                            [showClear]="true">
                            <ng-template pTemplate="item" let-employee>
                                <div>
                                    <div>{{employee.name}}</div>
                                    <div class="text-sm text-500">{{employee['user']?.['email']}} -
                                        {{employee['user']?.['roleName'] || 'Funcionário'}}</div>
                                </div>
                            </ng-template>
                        </p-dropdown>
                        <small *ngIf="contractForm.get('sellerId')?.invalid && contractForm.get('sellerId')?.touched"
                            class="p-error">
                            Vendedor é obrigatório
                        </small>
                    </div>

                    <!-- Start Date -->
                    <div class="field col-12 md:col-4">
                        <label for="startDate">Data de Início *</label>
                        <p-calendar id="startDate" formControlName="startDate" [showIcon]="true" dateFormat="yy-mm-dd"
                            placeholder="Selecione a data de início">
                        </p-calendar>
                        <small *ngIf="contractForm.get('startDate')?.invalid && contractForm.get('startDate')?.touched"
                            class="p-error">
                            Data de início é obrigatória
                        </small>
                    </div>

                    <!-- Discount Percent -->
                    <div class="field col-12 md:col-4">
                        <label for="discountPercent">Desconto (%)</label>
                        <p-inputNumber id="discountPercent" formControlName="discountPercent" [min]="0"
                            [max]="100"></p-inputNumber>
                    </div>

                    <!-- Contract Type -->
                    <div class="field col-12 md:col-4">
                        <label for="contractType">Tipo de Contrato *</label>
                        <p-dropdown id="contractType" formControlName="contractType" [options]="contractTypes"
                            optionLabel="label" optionValue="value" placeholder="Select contract type">
                        </p-dropdown>
                        <small
                            *ngIf="contractForm.get('contractType')?.invalid && contractForm.get('contractType')?.touched"
                            class="p-error">
                            Tipo de Contrato é obrigatório
                        </small>
                    </div>

                    <!-- Number of Installments -->
                    <div class="field col-12 md:col-6">
                        <label for="numberOfInstallments">Número de Parcelas *</label>
                        <p-inputNumber id="numberOfInstallments" formControlName="numberOfInstallments"
                            [min]="1"></p-inputNumber>
                        <small
                            *ngIf="contractForm.get('numberOfInstallments')?.invalid && contractForm.get('numberOfInstallments')?.touched"
                            class="p-error">
                            Número de Parcelas é obrigatório
                        </small>
                    </div>

                    <!-- Notes -->
                    <div class="field col-12 md:col-6">
                        <label for="notes">Notas</label>
                        <p-inputTextarea id="notes" formControlName="notes" placeholder="Enter contract notes">
                        </p-inputTextarea>
                    </div>

                    <!-- Contract Levels Section -->
                    <div class="col-12">
                        <div class="flex align-items-center justify-content-between mb-3">
                            <h6>Níveis de Contrato</h6>
                            <p-button type="button" label="Adicionar Nível" icon="pi pi-plus" class="p-button-sm"
                                (click)="addContractLevel()">
                            </p-button>
                        </div>

                        <div formArrayName="contractLevels">
                            <div class="card mb-3" *ngFor="let level of contractLevels.controls; let i = index"
                                [formGroupName]="i">
                                <div class="flex align-items-center justify-content-between mb-3">
                                    <h6 class="m-0">Nível {{i + 1}}</h6>
                                    <p-button *ngIf="contractLevels.length > 1" type="button" icon="pi pi-trash"
                                        class="p-button-sm p-button-danger p-button-text"
                                        (click)="removeContractLevel(i)">
                                    </p-button>
                                </div>

                                <div class="grid formgrid p-fluid">
                                    <!-- Level -->
                                    <div class="field col-12 md:col-6">
                                        <label>Nível *</label>
                                        <p-dropdown formControlName="levelId" [options]="levels" optionLabel="name"
                                            optionValue="id" placeholder="Select a level" [showClear]="true">
                                            <ng-template pTemplate="item" let-levelOption>
                                                <div>
                                                    <div>{{levelOption.name}}</div>
                                                    <div class="text-sm text-500">Duration: {{levelOption.duration}}
                                                        months - {{levelOption.maximumUnits}} units</div>
                                                </div>
                                            </ng-template>
                                        </p-dropdown>
                                        <small *ngIf="level.get('levelId')?.invalid && level.get('levelId')?.touched"
                                            class="p-error">
                                            Nível é obrigatório
                                        </small>
                                    </div>

                                    <!-- Product -->
                                    <div class="field col-12 md:col-6">
                                        <label>Produto *</label>
                                        <p-dropdown formControlName="productId" [options]="services" optionLabel="name"
                                            optionValue="id" placeholder="Select a product" [showClear]="true">
                                            <ng-template pTemplate="item" let-service>
                                                <div>
                                                    <div>{{service.name}}</div>
                                                    <div class="text-sm text-500">{{service.description}} -
                                                        ${{service.value}}</div>
                                                </div>
                                            </ng-template>
                                        </p-dropdown>
                                        <small
                                            *ngIf="level.get('productId')?.invalid && level.get('productId')?.touched"
                                            class="p-error">
                                            Produto é obrigatório
                                        </small>
                                    </div>

                                    <!-- Duration -->
                                    <div class="field col-12 md:col-3">
                                        <label>Duração (meses) *</label>
                                        <p-inputNumber formControlName="duration" [min]="1"></p-inputNumber>
                                        <small *ngIf="level.get('duration')?.invalid && level.get('duration')?.touched"
                                            class="p-error">
                                            Duração é obrigatória
                                        </small>
                                    </div>

                                    <!-- Level Price -->
                                    <div class="field col-12 md:col-3">
                                        <label>Preço do Nível *</label>
                                        <p-inputNumber formControlName="levelPrice" [min]="0" mode="decimal"
                                            [minFractionDigits]="2" [maxFractionDigits]="2" suffix=" AOA"></p-inputNumber>
                                        <small
                                            *ngIf="level.get('levelPrice')?.invalid && level.get('levelPrice')?.touched"
                                            class="p-error">
                                            Preço do Nível é obrigatório
                                        </small>
                                    </div>

                                    <!-- Course Material Price -->
                                    <div class="field col-12 md:col-3">
                                        <label>Preço do Material do Curso *</label>
                                        <p-inputNumber formControlName="courseMaterialPrice" [min]="0" mode="decimal"
                                            [minFractionDigits]="2" [maxFractionDigits]="2" suffix=" AOA"></p-inputNumber>
                                        <small
                                            *ngIf="level.get('courseMaterialPrice')?.invalid && level.get('courseMaterialPrice')?.touched"
                                            class="p-error">
                                            Preço do Material do Curso é obrigatório
                                        </small>
                                    </div>

                                    <!-- Level Order -->
                                    <div class="field col-12 md:col-3">
                                        <label>Ordem do Nível *</label>
                                        <p-inputNumber formControlName="levelOrder" [min]="1"></p-inputNumber>
                                        <small
                                            *ngIf="level.get('levelOrder')?.invalid && level.get('levelOrder')?.touched"
                                            class="p-error">
                                            Ordem do Nível é obrigatória
                                        </small>
                                    </div>

                                    <!-- Offer Type -->
                                    <div class="field col-12 md:col-4">
                                        <label>Tipo de Oferta *</label>
                                        <p-dropdown formControlName="offerType" [options]="offerTypes"
                                            optionLabel="label" optionValue="value" placeholder="Select offer type">
                                        </p-dropdown>
                                    </div>

                                    <!-- Registration Fee Type -->
                                    <div class="field col-12 md:col-4">
                                        <label>Tipo de Taxa de Registro *</label>
                                        <p-dropdown formControlName="registrationFeeType"
                                            [options]="registrationFeeTypes" optionLabel="label" optionValue="value"
                                            placeholder="Select registration fee type">
                                        </p-dropdown>
                                    </div>

                                    <!-- Status -->
                                    <div class="field col-12 md:col-4">
                                        <label>Status *</label>
                                        <p-dropdown formControlName="status" [options]="statuses" optionLabel="label"
                                            optionValue="value" placeholder="Select status">
                                        </p-dropdown>
                                    </div>

                                    <!-- Contract Type for Level -->
                                    <div class="field col-12 md:col-6">
                                        <label>Tipo de Contrato do Nível *</label>
                                        <p-dropdown formControlName="contractType" [options]="contractTypes"
                                            optionLabel="label" optionValue="value" placeholder="Select contract type">
                                        </p-dropdown>
                                    </div>

                                    <!-- Checkboxes -->
                                    <div class="field col-12 md:col-6">
                                        <div class="grid">
                                            <div class="col-12">
                                                <div class="flex align-items-center gap-2">
                                                    <input type="checkbox" formControlName="courseMaterialPaid" />
                                                    <label>Material do Curso Pago</label>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="flex align-items-center gap-2">
                                                    <input type="checkbox" formControlName="includeCourseMaterial" />
                                                    <label>Incluir Material do Curso</label>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="flex align-items-center gap-2">
                                                    <input type="checkbox" formControlName="includeRegistrationFee" />
                                                    <label>Incluir Taxa de Registro</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Notes for Level -->
                                    <div class="field col-12">
                                        <label>Notas do Nível</label>
                                        <p-inputTextarea formControlName="notes"
                                            placeholder="Enter level-specific notes">
                                        </p-inputTextarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Summary Section -->
                    <div class="col-12">
                        <div class="card">
                            <h6>Resumo do Contrato</h6>
                            <div class="grid">
                                <div class="col-12 md:col-6">
                                    <div class="flex justify-content-between mb-2">
                                        <span>Preço Total dos Níveis:</span>
                                        <span class="font-semibold">{{contractSummary.totalLevelPrice | number:'1.2-2'}} AOA</span>
                                    </div>
                                    <div class="flex justify-content-between mb-2">
                                        <span>Preço Total dos Materiais:</span>
                                        <span class="font-semibold">{{contractSummary.totalMaterialPrice | number:'1.2-2'}} AOA</span>
                                    </div>
                                    <div class="flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span class="font-semibold">{{contractSummary.totalAmount | number:'1.2-2'}} AOA</span>
                                    </div>
                                    <div class="flex justify-content-between mb-2" *ngIf="contractSummary.totalDiscount > 0">
                                        <span>Desconto ({{contractForm.get('discountPercent')?.value || 0}}%):</span>
                                        <span class="font-semibold text-red-500">-{{contractSummary.totalDiscount | number:'1.2-2'}} AOA</span>
                                    </div>
                                    <hr>
                                    <div class="flex justify-content-between mb-2">
                                        <span class="font-bold text-lg">Total Final:</span>
                                        <span class="font-bold text-lg text-primary">{{contractSummary.finalAmount | number:'1.2-2'}} AOA</span>
                                    </div>
                                    <div class="flex justify-content-between" *ngIf="contractForm.get('numberOfInstallments')?.value > 1">
                                        <span class="font-semibold text-blue-600">Valor por Parcela:</span>
                                        <span class="font-semibold text-blue-600">{{contractSummary.installmentAmount | number:'1.2-2'}} AOA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Installments Section -->
                    <div class="col-12" *ngIf="installments.length > 0">
                        <div class="card">
                            <h6>Plano de Parcelas</h6>
                            <div class="grid">
                                <div class="col-12">
                                    <p-table [value]="installments" [tableStyle]="{'min-width': '50rem'}">
                                        <ng-template pTemplate="header">
                                            <tr>
                                                <th>Parcela</th>
                                                <th>Data de Vencimento</th>
                                                <th>Valor</th>
                                                <th>Status</th>
                                            </tr>
                                        </ng-template>
                                        <ng-template pTemplate="body" let-installment>
                                            <tr>
                                                <td>{{installment.installmentNumber}}/{{installments.length}}</td>
                                                <td>{{installment.dueDate | date:'dd/MM/yyyy'}}</td>
                                                <td>{{installment.amount | number:'1.2-2'}} AOA</td>
                                                <td>
                                                    <span class="p-tag p-tag-warning">Pendente</span>
                                                </td>
                                            </tr>
                                        </ng-template>
                                    </p-table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-content-end mt-4">
                    <p-button type="submit" label="Criar Contrato" icon="pi pi-check" [loading]="loading"
                        [disabled]="contractForm.invalid">
                    </p-button>
                </div>
            </form>
        </div>
    </div>
</div>
