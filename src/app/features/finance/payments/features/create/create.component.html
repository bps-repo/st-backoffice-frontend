<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Create Payment Plan</h1>
    <a routerLink="/finances/payments" class="btn btn-secondary">Back to Installments</a>
  </div>

  <div class="card">
    <div class="card-body">
      <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()">
        <!-- Contract Selection -->
        <div class="mb-3">
          <label for="invoice_id" class="form-label">Contract</label>
          <select id="invoice_id" formControlName="invoice_id" class="form-select"
            [class.is-invalid]="paymentForm.get('invoice_id')?.invalid && paymentForm.get('invoice_id')?.touched">
            <option value="">Select a contract</option>
            <option *ngFor="let invoice of invoices" [value]="invoice.id">
              {{ invoice.invoice_number }} - {{ invoice.client }} (${{ invoice.amount }})
            </option>
          </select>
          <div class="invalid-feedback" *ngIf="paymentForm.get('invoice_id')?.invalid && paymentForm.get('invoice_id')?.touched">
            Please select a contract.
          </div>
        </div>

        <!-- Payment Details -->
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label for="amount" class="form-label">Payment Amount</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" id="amount" formControlName="amount" class="form-control"
                  [class.is-invalid]="paymentForm.get('amount')?.invalid && paymentForm.get('amount')?.touched">
              </div>
              <div class="invalid-feedback" *ngIf="paymentForm.get('amount')?.invalid && paymentForm.get('amount')?.touched">
                Please enter a valid amount.
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="payment_method" class="form-label">Payment Method</label>
              <select id="payment_method" formControlName="payment_method" class="form-select"
                [class.is-invalid]="paymentForm.get('payment_method')?.invalid && paymentForm.get('payment_method')?.touched">
                <option value="">Select payment method</option>
                <option *ngFor="let method of paymentMethods" [value]="method">{{ method }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="paymentForm.get('payment_method')?.invalid && paymentForm.get('payment_method')?.touched">
                Please select a payment method.
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="payment_date" class="form-label">Payment Date</label>
              <input type="date" id="payment_date" formControlName="payment_date" class="form-control"
                [class.is-invalid]="paymentForm.get('payment_date')?.invalid && paymentForm.get('payment_date')?.touched">
              <div class="invalid-feedback" *ngIf="paymentForm.get('payment_date')?.invalid && paymentForm.get('payment_date')?.touched">
                Please select a valid date.
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="reference" class="form-label">Reference (Optional)</label>
              <input type="text" id="reference" formControlName="reference" class="form-control">
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label for="notes" class="form-label">Notes (Optional)</label>
              <textarea id="notes" formControlName="notes" class="form-control" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Installments Toggle -->
        <div class="mb-3 form-check">
          <input type="checkbox" id="installments_enabled" formControlName="installments_enabled" class="form-check-input">
          <label for="installments_enabled" class="form-check-label">Enable Installment Plan</label>
        </div>

        <!-- Installments Configuration -->
        <div *ngIf="paymentForm.get('installments_enabled')?.value" class="card mb-3 bg-light">
          <div class="card-body">
            <h5 class="card-title">Installment Configuration</h5>

            <div class="mb-3">
              <label for="total_installments" class="form-label">Number of Installments</label>
              <input type="number" id="total_installments" formControlName="total_installments" class="form-control" min="1" max="12"
                [class.is-invalid]="paymentForm.get('total_installments')?.invalid && paymentForm.get('total_installments')?.touched">
              <div class="invalid-feedback" *ngIf="paymentForm.get('total_installments')?.invalid && paymentForm.get('total_installments')?.touched">
                Please enter a number between 1 and 12.
              </div>
            </div>

            <!-- Installments Preview -->
            <h6 class="mt-4">Installments Preview</h6>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Amount</th>
                    <th>Due Date</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container formArrayName="installments">
                    <tr *ngFor="let installment of installmentsArray.controls; let i = index" [formGroupName]="i">
                      <td>{{ i + 1 }}</td>
                      <td>
                        <div class="input-group input-group-sm">
                          <span class="input-group-text">$</span>
                          <input type="number" formControlName="amount" class="form-control">
                        </div>
                      </td>
                      <td>
                        <input type="date" formControlName="due_date" class="form-control form-control-sm">
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
                <tfoot>
                  <tr class="table-info">
                    <th>Total</th>
                    <th colspan="2">${{ paymentForm.get('amount')?.value || 0 }}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-end">
          <button type="button" routerLink="/payments/installments" class="btn btn-secondary me-2">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="paymentForm.invalid">Create Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>
