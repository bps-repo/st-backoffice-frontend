<div class="grid">
    <!-- Header -->
    <div class="col-12">
        <div class="flex align-items-center gap-3 mb-4">
            <button pButton icon="pi pi-arrow-left" class="p-button-text" (click)="onCancel()"></button>
            <div>
                <h1 class="text-3xl font-bold text-900 mb-1">Nova Venda Avulsa</h1>
                <p class="text-lg text-600 mb-0">Registre uma nova venda avulsa</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    @if (error) {
    <div class="col-12">
        <div class="p-4 mb-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="pi pi-times-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">
                        Erro ao criar venda
                    </h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p>{{ error }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    <form [formGroup]="saleForm" (ngSubmit)="onSave()">
        <div class="grid">
            <!-- Left Column -->
            <div class="col-12 lg:col-8">
                <!-- Client Data Card -->
                <div class="card mb-4">
                    <h3 class="text-xl font-semibold mb-4">Dados do Cliente</h3>
                    <p class="text-color-secondary mb-4">Informe os dados do cliente ou busque no cadastro existente</p>

                    <div class="grid">
                        <div class="col-12">
                            <label class="block text-600 font-medium mb-2">Nome do Cliente *</label>
                            <div class="p-inputgroup">
                                <input type="text" pInputText formControlName="client.name"
                                    placeholder="Digite o nome do cliente" class="w-full" />
                                <span class="p-inputgroup-addon">
                                    <i class="pi pi-search"></i>
                                </span>
                            </div>
                            @if (saleForm.get('client.name')?.invalid && saleForm.get('client.name')?.touched) {
                            <small class="p-error block mt-1">Nome do cliente é obrigatório</small>
                            }
                        </div>

                        <div class="col-12 md:col-6">
                            <label class="block text-600 font-medium mb-2">Email (opcional)</label>
                            <input type="email" pInputText formControlName="client.email"
                                placeholder="cliente@email.com" class="w-full" />
                        </div>

                        <div class="col-12 md:col-6">
                            <label class="block text-600 font-medium mb-2">Telefone (opcional)</label>
                            <input type="tel" pInputText formControlName="client.phone" placeholder="+244 900 000 000"
                                class="w-full" />
                        </div>
                    </div>
                </div>

                <!-- Product/Service Data Card -->
                <div class="card mb-4 ">
                    <h3 class="text-xl font-semibold mb-4">Dados do Produto/Serviço</h3>

                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <label class="block text-600 font-medium mb-2">Tipo de Produto *</label>
                            <p-dropdown [options]="productTypeOptions" formControlName="product.type"
                                placeholder="Selecione o tipo" optionLabel="label" optionValue="value"
                                class="w-full"></p-dropdown>
                            @if (saleForm.get('product.type')?.invalid && saleForm.get('product.type')?.touched) {
                            <small class="p-error block mt-1">Tipo de produto é obrigatório</small>
                            }
                        </div>

                        <div class="col-12 md:col-6">
                            <label class="block text-600 font-medium mb-2">Produto/Serviço *</label>
                            <p-dropdown [options]="availableProducts" formControlName="product.name"
                                placeholder="Selecione o produto" optionLabel="label" optionValue="value" class="w-full"
                                [disabled]="!saleForm.get('product.type')?.value"></p-dropdown>
                            @if (saleForm.get('product.name')?.invalid && saleForm.get('product.name')?.touched) {
                            <small class="p-error block mt-1">Produto é obrigatório</small>
                            }
                        </div>

                        <div class="col-12 md:col-4">
                            <label class="block text-600 font-medium mb-2">Quantidade *</label>
                            <p-inputNumber formControlName="product.quantity" [min]="1" [max]="999"
                                class="w-full"></p-inputNumber>
                            @if (saleForm.get('product.quantity')?.invalid && saleForm.get('product.quantity')?.touched)
                            {
                            <small class="p-error block mt-1">Quantidade deve ser maior que 0</small>
                            }
                        </div>

                        <div class="col-12 md:col-4">
                            <label class="block text-600 font-medium mb-2">Preço Unitário (AOA) *</label>
                            <p-inputNumber formControlName="product.unitPrice" [min]="0" [maxFractionDigits]="2"
                                [minFractionDigits]="2" class="w-full"></p-inputNumber>
                            @if (saleForm.get('product.unitPrice')?.invalid &&
                            saleForm.get('product.unitPrice')?.touched) {
                            <small class="p-error block mt-1">Preço unitário deve ser maior ou igual a 0</small>
                            }
                        </div>

                        <div class="col-12 md:col-4">
                            <label class="block text-600 font-medium mb-2">Método de Pagamento *</label>
                            <p-dropdown [options]="paymentMethodOptions" formControlName="payment.method"
                                optionLabel="label" optionValue="value" class="w-full"></p-dropdown>
                        </div>

                        <div class="col-12">
                            <label class="block text-600 font-medium mb-2">Observações (opcional)</label>
                            <textarea pInputTextarea formControlName="notes" rows="3"
                                placeholder="Adicione observações sobre a venda..." class="w-full"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Sale Summary -->
            <div class="col-12 lg:col-4">
                <div class="card mb-4">
                    <h3 class="text-lg font-semibold mb-4">Resumo da Venda</h3>

                    <div class="flex flex-column gap-3">
                        <div class="flex justify-content-between align-items-center">
                            <span class="text-600">Quantidade:</span>
                            <span class="text-900 font-medium">{{ saleForm.get('product.quantity')?.value || 0 }}</span>
                        </div>

                        <div class="flex justify-content-between align-items-center">
                            <span class="text-600">Preço Unitário:</span>
                            <span class="text-900 font-medium">{{ (saleForm.get('product.unitPrice')?.value || 0) |
                                currency:'Kz':'symbol':'1.2-2' }}</span>
                        </div>

                        <div class="border-top-1 surface-border pt-3">
                            <div class="flex justify-content-between align-items-center">
                                <span class="text-900 font-semibold">Total:</span>
                                <span class="text-900 font-bold text-xl text-blue-600">{{ totalAmount |
                                    currency:'Kz':'symbol':'1.2-2' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="col-12 mt-4">
            <div class="flex justify-content-end gap-3">
                <button type="button" pButton label="Cancelar" class="p-button-text" (click)="onCancel()"
                    [disabled]="loading"></button>

                <button type="submit" pButton label="Salvar" icon="pi pi-save" class="p-button-primary"
                    [disabled]="!isFormValid || loading" [loading]="loading"></button>

                <button type="button" pButton label="Salvar e Emitir Fatura" icon="pi pi-file-pdf" class="p-button-info"
                    [disabled]="!isFormValid || loading" (click)="onSaveAndIssueInvoice()"></button>

                <button type="button" pButton label="Salvar e Emitir Recibo" icon="pi pi-receipt"
                    class="p-button-success" [disabled]="!isFormValid || loading"
                    (click)="onSaveAndIssueReceipt()"></button>
            </div>
        </div>
    </form>
</div>
