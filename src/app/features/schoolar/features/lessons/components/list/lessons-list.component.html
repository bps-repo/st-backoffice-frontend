<div class="grid">
    <div #mainHeader id="mainHeader" class="col-12 flex justify-content-between items-center mb-4 sticky-header"
        [ngClass]="{'sticky-active': isMainHeaderSticky}">
        <div>
            <h2 class="font-bold text-2xl mb-4">Gestão de aulas</h2>
            <span class="text-lg">Sistema completo para criação, gerenciamento e análise de aulas</span>
        </div>
        <p-button label="Novo aula" icon="pi pi-plus" class="p-button-outlined"
            (click)="navigateToCreateLesson()"></p-button>
    </div>

    <div #viewSelector id="viewSelector" class="col-12 flex justify-content-start gap-2 items-center mb-4 sticky-header"
        style="top: 80px;" [ngClass]="{'sticky-active': isViewSelectorSticky}">
        <p-selectButton [options]="viewOptions" [(ngModel)]="currentView" (onChange)="onViewChange($event)"
            optionLabel="label" optionValue="value"></p-selectButton>
    </div>

    <!-- Lista de aulas View -->
    @if (currentView === 'list') {
    <div class="col-12 animate-fade">
        <div class="flex justify-content-between align-items-center mb-3">
            <div class="flex align-items-center">
                <span class="p-input-icon-left mr-2">
                    <i class="pi pi-search"></i>
                    <input type="text" pInputText placeholder="Buscar aulas" />
                </span>
                <p-dropdown [options]="[
                        {label: 'Status', value: 'status'},
                        {label: 'Data', value: 'date'},
                        {label: 'Nível', value: 'level'},
                        {label: 'Tipo', value: 'type'}
                    ]" placeholder="Filtrar por" class="mr-2"></p-dropdown>
            </div>
            <div class="flex">
                <p-button icon="pi pi-table" class="mr-2" pTooltip="Visualização em tabela"></p-button>
                <p-button icon="pi pi-th-large" class="mr-2" pTooltip="Visualização em cards"></p-button>
                <p-button icon="pi pi-download" label="Exportar" pTooltip="Exportar"></p-button>
            </div>
        </div>

        <!-- Error message -->
        @if (error$ | async; as error) {
        <div class="p-4 mb-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="pi pi-times-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">
                        Erro ao carregar aulas
                    </h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p>{{ error }}</p>
                    </div>
                    <div class="mt-4">
                        <div class="flex space-x-2">
                            <p-button label="Tentar novamente" size="small" severity="danger" [outlined]="true"
                                (click)="retryLoadLessons()">
                            </p-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }

        <app-global-table tableLabel="Aulas" [columnTemplates]="columnTemplates" [data]="lessons$ | async"
            [loading]="loading$ | async" [entity]="'lessons'" [columns]="columns"
            [globalFilterFields]="globalFilterFields" class="w-full"
            (createEntity)="navigateToCreateLesson()"></app-global-table>
    </div>
    }

    <!-- Relatorios View -->
    @if (currentView === 'relatorios') {
    <app-lesson-reports></app-lesson-reports>
    }

    <!-- Calendario View -->
    @if (currentView === 'calendario') {
    <div class="col-12 animate-fade">
        <!-- Error message for calendar -->
        @if (error$ | async; as error) {
        <div class="p-4 mb-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="pi pi-times-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">
                        Erro ao carregar aulas do calendário
                    </h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p>{{ error }}</p>
                    </div>
                    <div class="mt-4">
                        <div class="flex space-x-2">
                            <p-button label="Tentar novamente" size="small" severity="danger" [outlined]="true"
                                (click)="retryLoadLessons()">
                            </p-button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }

        <!-- Loading indicator for calendar -->
        @if (loading$ | async) {
        <div class="flex justify-content-center align-items-center p-4 mb-4">
            <i class="pi pi-spin pi-spinner mr-2"></i>
            <span>Carregando aulas...</span>
        </div>
        }

        <!-- Calendar controls -->
        <div class="flex justify-content-between align-items-center mb-4">
            <div class="flex align-items-center gap-2">
                <button pButton type="button" icon="pi pi-chevron-left" class="p-button-rounded p-button-text"
                    (click)="navigatePrevious()"></button>
                <h3 class="font-bold text-xl m-0">
                    @if (calendarView === 'week') {
                    {{ getFormattedWeekRange() }}
                    } @else {
                    {{ getFormattedMonth() }}
                    }
                </h3>
                <button pButton type="button" icon="pi pi-chevron-right" class="p-button-rounded p-button-text"
                    (click)="navigateNext()"></button>
            </div>

            <div class="flex gap-2">
                <button pButton type="button" label="Filtros" icon="pi pi-filter" class="p-button-outlined"></button>
                <div class="flex">
                    <button pButton type="button" label="Mês" [class.p-button-outlined]="calendarView !== 'month'"
                        [class.p-button-info]="calendarView === 'month'" (click)="switchCalendarView('month')"></button>
                    <button pButton type="button" label="Semana" [class.p-button-outlined]="calendarView !== 'week'"
                        [class.p-button-info]="calendarView === 'week'" (click)="switchCalendarView('week')"></button>
                    <button pButton type="button" label="Hoje" class="p-button-outlined"
                        (click)="navigateToday()"></button>
                </div>
            </div>
        </div>

        <!-- Weekly Calendar View -->
        @if (calendarView === 'week') {
        <div class="weekly-calendar card">
            <div class="grid gap-2">
                @for (dayData of weeklyLessons; track dayData.date) {
                <div class="col-12 md:col">
                    <div class="card h-full" [class.today-card]="dayData.isToday">
                        <div class="card-header text-center mb-3">
                            <div class="day-header">
                                <div class="day-name text-sm text-gray-600">{{ dayData.day.split(' ')[0] }}</div>
                                <div class="day-date font-bold" [class.today-date]="dayData.isToday">
                                    {{ dayData.day.split(' ')[1] }}
                                </div>
                            </div>
                            @if (dayData.isToday) {
                            <div class="today-label text-xs text-primary font-bold">Hoje</div>
                            }
                            @if (!dayData.classes?.length) {
                            <div class="no-lessons text-xs text-gray-500 mt-2">Nenhuma aula agendada</div>
                            }
                        </div>

                        <div class="classes-list">
                            @for (classItem of dayData.classes; track $index) {
                            <div class="class-card mb-2 p-2 border-round cursor-pointer hover:bg-gray-50 transition-colors cursor-pointer"
                                [class]="'border-left-3 border-' + classItem.statusClass"
                                (mouseenter)="showLessonDetails(classItem.lesson)" (mouseleave)="hideLessonDetails()"
                                (click)="viewLesson(classItem.lesson.id!)">
                                <div class="flex align-items-center justify-content-between mb-1">
                                    <div class="flex align-items-center gap-1">
                                        <i class="pi pi-clock text-xs text-gray-600"></i>
                                        <span class="text-sm font-bold">{{ classItem.time }}</span>
                                    </div>
                                </div>
                                <div class="class-title text-sm font-medium mb-1">{{ classItem.title }}</div>
                                <div class="class-details text-xs text-gray-600 mb-1">
                                    {{ classItem.teacher }}<br>
                                    {{ classItem.group }}
                                </div>
                                <div class="status-badge">
                                    <span class="p-badge" [class]="'p-badge-' + classItem.statusClass">
                                        {{ classItem.status }}
                                    </span>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        }

        <!-- Monthly Calendar View -->
        @if (calendarView === 'month') {
        <div class="monthly-calendar">
            <div class="card">
                <div class="calendar-header grid border-bottom-1 border-gray-200 font-bold text-center">
                    <div class="col">Dom</div>
                    <div class="col">Seg</div>
                    <div class="col">Ter</div>
                    <div class="col">Qua</div>
                    <div class="col">Qui</div>
                    <div class="col">Sex</div>
                    <div class="col">Sáb</div>
                </div>

                <div class="calendar-body">
                    <!-- July 2025 Calendar Grid -->
                    <div class="grid calendar-week border-bottom-1 border-gray-100">
                        <div class="col calendar-day text-gray-400">29</div>
                        <div class="col calendar-day text-gray-400">30</div>
                        <div class="col calendar-day">1</div>
                        <div class="col calendar-day">2</div>
                        <div class="col calendar-day">3</div>
                        <div class="col calendar-day">4</div>
                        <div class="col calendar-day">5</div>
                    </div>
                    <div class="grid calendar-week border-bottom-1 border-gray-100">
                        <div class="col calendar-day">6</div>
                        <div class="col calendar-day">7</div>
                        <div class="col calendar-day">8</div>
                        <div class="col calendar-day">9</div>
                        <div class="col calendar-day">10</div>
                        <div class="col calendar-day">11</div>
                        <div class="col calendar-day">12</div>
                    </div>
                    <div class="grid calendar-week border-bottom-1 border-gray-100">
                        <div class="col calendar-day">13</div>
                        <div class="col calendar-day">14</div>
                        <div class="col calendar-day">15</div>
                        <div class="col calendar-day">16</div>
                        <div class="col calendar-day">17</div>
                        <div class="col calendar-day">18</div>
                        <div class="col calendar-day">19</div>
                    </div>
                    <div class="grid calendar-week border-bottom-1 border-gray-100">
                        <div class="col calendar-day">20</div>
                        <div class="col calendar-day">21</div>
                        <div class="col calendar-day">22</div>
                        <div class="col calendar-day">23</div>
                        <div class="col calendar-day">24</div>
                        <div class="col calendar-day">25</div>
                        <div class="col calendar-day">26</div>
                    </div>
                    <div class="grid calendar-week">
                        <div class="col calendar-day">27</div>
                        <div class="col calendar-day">28</div>
                        <div class="col calendar-day">29</div>
                        <div class="col calendar-day">30</div>
                        <div class="col calendar-day">31</div>
                        <div class="col calendar-day text-gray-400">1</div>
                        <div class="col calendar-day text-gray-400">2</div>
                    </div>
                </div>
            </div>
        </div>
        }
    </div>
    }

    <!-- Estatisticas View -->
    @if (currentView === 'estatisticas') {
    <div class="col-12 animate-fade content-sticky">
        <div class="p-4 text-center">
            <h3>Estatísticas</h3>
            <p>Conteúdo das estatísticas será implementado aqui.</p>
        </div>
    </div>
    }

    <!-- Nova Aula View -->
    @if (currentView === 'nova-aula') {
    <div class="col-12 animate-fade content-sticky">
        <div class="p-4 text-center">
            <h3>Nova Aula</h3>
            <p>Formulário para criar nova aula será implementado aqui.</p>
            <button pButton type="button" label="Voltar à Lista" class="p-button-outlined mt-3"
                (click)="currentView = 'list'"></button>
        </div>
    </div>
    }
</div>


<ng-template #teacherTemplate let-row>
    <span>
        {{ getTeacherName(row) }}
    </span>
</ng-template>

<ng-template #centerTemplate let-row>
    <span>
        {{ getCenterName(row) }}
    </span>
</ng-template>

<ng-template #unitTemplate let-row>
    <span>
        {{ getUnitName(row) }}
    </span>
</ng-template>

<ng-template #onlineTemplate let-row>
    <span>{{ row.online ? 'Online' : 'Presencial' }}</span>
</ng-template>

<ng-template #statusTemplate let-row>
    <span class="p-badge" [ngClass]="{
            'p-badge-success': row.status === 'COMPLETED' || row.status === 'AVAILABLE',
            'p-badge-warning': row.status === 'SCHEDULED' || row.status === 'BOOKED',
            'p-badge-danger': row.status === 'CANCELLED' || row.status === 'OVERDUE',
            'p-badge-info': row.status === 'POSTPONED'
          }">
        {{ getStatusLabel(row.status) }}
    </span>
</ng-template>

<ng-template #actionsTemplate let-row>
    <div class="flex gap-2">
        <p-button icon="pi pi-eye" size="small" severity="info" [outlined]="true" pTooltip="Ver detalhes"
            (mouseenter)="showLessonDetails(row)" (mouseleave)="hideLessonDetails()"
            (click)="viewLesson(row.id)"></p-button>
        <p-button icon="pi pi-pencil" size="small" severity="secondary" [outlined]="true" pTooltip="Editar"
            (click)="editLesson(row.id)"></p-button>
        @if (row.online && row.onlineLink) {
        <p-button icon="pi pi-external-link" size="small" severity="help" [outlined]="true"
            pTooltip="Abrir link da aula" (click)="openOnlineLink(row.onlineLink)"></p-button>
        }
    </div>
</ng-template>

<ng-template #startDatetime let-row>
    <span>
        {{ getFormattedDateTime(row.startDatetime, row.endDatetime) }}
    </span>
</ng-template>


<ng-template #actionsTemplate let-row>
    <span>
        ver
    </span>
</ng-template>

<!-- Lesson Details Dialog -->
<p-dialog [header]="selectedLesson?.title || 'Detalhes da Aula'" [visible]="lessonDialogVisible()" [modal]="false"
    [closable]="true" [draggable]="false" [resizable]="false" styleClass="lesson-details-dialog"
    [style]="{width: '400px'}" (mouseenter)="keepDialogOpen()" (mouseleave)="onDialogMouseLeave()">

    @if (selectedLesson) {
    <div class="lesson-details-content">
        <!-- Status Badge -->
        <div class="flex justify-content-between align-items-center mb-3">
            <span class="p-badge text-sm" [ngClass]="{
                        'p-badge-success': selectedLesson.status === 'COMPLETED' || selectedLesson.status === 'AVAILABLE',
                        'p-badge-warning': selectedLesson.status === 'SCHEDULED' || selectedLesson.status === 'BOOKED',
                        'p-badge-danger': selectedLesson.status === 'CANCELLED' || selectedLesson.status === 'OVERDUE',
                        'p-badge-info': selectedLesson.status === 'POSTPONED'
                      }">
                {{ getStatusLabel(selectedLesson.status) }}
            </span>
            <span class="text-sm text-500">{{ selectedLesson.startDatetime | date: 'dd/MM/yyyy' }}</span>
        </div>

        <!-- Time -->
        <div class="flex align-items-center gap-2 mb-3">
            <i class="pi pi-clock text-600"></i>
            <span class="font-medium">{{ (selectedLesson.startDatetime | date: 'HH:mm') + ' - ' +
                (selectedLesson.endDatetime | date: 'HH:mm') }}</span>
        </div>

        <!-- Teacher -->
        <div class="flex align-items-center gap-2 mb-3">
            <i class="pi pi-user text-600"></i>
            <span>{{ getTeacherName(selectedLesson) }}</span>
        </div>

        <!-- Class/Group -->
        <div class="flex align-items-center gap-2 mb-3">
            <i class="pi pi-users text-600"></i>
            <span>{{ selectedLesson.level || 'N/A' }}</span>
        </div>

        <!-- Center -->
        <div class="flex align-items-center gap-2 mb-3">
            <i class="pi pi-map-marker text-600"></i>
            <span>{{ getCenterName(selectedLesson) }}</span>
        </div>

        <!-- Students -->
        <div class="mb-3">
            <h6 class="text-900 font-semibold mb-2 flex align-items-center gap-2">
                <i class="pi pi-users text-600"></i>
                Alunos ({{ selectedLesson.students?.length || 0 }})
            </h6>
            <div class="text-sm text-700">
                {{ getStudentsString(selectedLesson) }}
            </div>
        </div>

        <!-- Materials -->
        <div class="mb-3">
            <h6 class="text-900 font-semibold mb-2 flex align-items-center gap-2">
                <i class="pi pi-book text-600"></i>
                Materiais ({{ selectedLesson.materials?.length || 0 }})
            </h6>
            <div class="text-sm text-700">
                {{ getMaterialsString(selectedLesson) }}
            </div>
        </div>

        <!-- Description -->
        @if (selectedLesson.description) {
        <div class="mb-3">
            <h6 class="text-900 font-semibold mb-2">Descrição</h6>
            <div class="text-sm text-700">
                {{ selectedLesson.description }}
            </div>
        </div>
        }

        <!-- Online Link -->
        @if (selectedLesson.online && selectedLesson.onlineLink) {
        <div class="mb-3">
            <h6 class="text-900 font-semibold mb-2 flex align-items-center gap-2">
                <i class="pi pi-globe text-600"></i>
                Aula Online
            </h6>
            <p-button label="Abrir Link da Aula" icon="pi pi-external-link" size="small" [outlined]="true"
                (click)="openOnlineLink(selectedLesson.onlineLink!)">
            </p-button>
        </div>
        }
    </div>
    }
</p-dialog>
