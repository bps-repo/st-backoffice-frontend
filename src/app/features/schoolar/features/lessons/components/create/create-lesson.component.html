<p-toast></p-toast>

<div class="grid">
    <div class="col-12">
        <div *ngIf="errors$ | async" class="alert alert-danger">
            {{ errors$ | async }}
        </div>
        <div class="card">
            <h5>Criar aula</h5>
            <form [formGroup]="lessonForm" (ngSubmit)="saveLesson()">
                <div class="p-fluid grid">
                    <!-- Title Field -->
                    <div class="col-12 field">
                        <label for="title" class="font-bold">Título *</label>
                        <input
                            id="title"
                            type="text"
                            pInputText
                            formControlName="title"
                            placeholder="Enter lesson title"
                            [class.ng-invalid]="isFieldInvalid('title')"
                            [class.ng-dirty]="lessonForm.get('title')?.dirty">
                        <small class="p-error block" *ngIf="isFieldInvalid('title')">
                            {{ getFieldError('title') }}
                        </small>
                    </div>

                    <!-- Level Field -->
                    <div class="col-12 field">
                        <label for="levelId" class="font-bold">Nível *</label>
                        <p-dropdown
                            id="levelId"
                            [options]="levelOptions"
                            formControlName="levelId"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select a level"
                            [showClear]="true"
                            [class.ng-invalid]="isFieldInvalid('levelId')"
                            [class.ng-dirty]="lessonForm.get('levelId')?.dirty">
                        </p-dropdown>
                        <small class="p-error block" *ngIf="isFieldInvalid('levelId')">
                            {{ getFieldError('levelId') }}
                        </small>
                    </div>

                    <!-- Center Field - Now Required -->
                    <div class="col-12 field">
                        <label for="centerId" class="font-bold">Centro *</label>
                        <p-dropdown
                            id="centerId"
                            [options]="centerOptions"
                            formControlName="centerId"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select a center"
                            [showClear]="true"
                            [class.ng-invalid]="isFieldInvalid('centerId')"
                            [class.ng-dirty]="lessonForm.get('centerId')?.dirty">
                        </p-dropdown>
                        <small class="p-error block" *ngIf="isFieldInvalid('centerId')">
                            {{ getFieldError('centerId') }}
                        </small>
                    </div>

                    <!-- Teacher Field - Depends on Center -->
                    <div class="col-12 field">
                        <label for="teacherId" class="font-bold">Professor *</label>
                        <p-dropdown
                            id="teacherId"
                            [options]="teacherOptions"
                            formControlName="teacherId"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select a teacher"
                            [showClear]="true"
                            [disabled]="!lessonForm.get('centerId')?.value"
                            [class.ng-invalid]="isFieldInvalid('teacherId')"
                            [class.ng-dirty]="lessonForm.get('teacherId')?.dirty">
                        </p-dropdown>
                        <small class="p-error block" *ngIf="isFieldInvalid('teacherId')">
                            {{ getFieldError('teacherId') }}
                        </small>
                        <small class="text-muted block" *ngIf="!lessonForm.get('centerId')?.value">
                            Please select a center first to view available teachers
                        </small>
                    </div>

                    <!-- Class Field - Depends on Center -->
                    <div class="col-12 md:col-6 field">
                        <label for="classId" class="font-bold">Turma</label>
                        <p-dropdown
                            id="classId"
                            [options]="classOptions"
                            formControlName="classId"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select a class"
                            [showClear]="true"
                            [disabled]="!lessonForm.get('centerId')?.value">
                        </p-dropdown>
                        <small class="text-muted block" *ngIf="!lessonForm.get('centerId')?.value">
                            Please select a center first to view available classes
                        </small>
                    </div>

                    <!-- Unit Field -->
                    <div class="col-12 md:col-6 field">
                        <label for="unitId" class="font-bold">Unidade</label>
                        <p-dropdown
                            id="unitId"
                            [options]="unitOptions"
                            formControlName="unitId"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select a unit"
                            [showClear]="true">
                        </p-dropdown>
                    </div>

                    <!-- Start Date/Time Field -->
                    <div class="col-12 md:col-6 field">
                        <label for="startDatetime" class="font-bold">Inicio *</label>
                        <p-calendar
                            id="startDatetime"
                            formControlName="startDatetime"
                            [showIcon]="true"
                            [showTime]="true"
                            dateFormat="dd/mm/yy"
                            [class.ng-invalid]="isFieldInvalid('startDatetime')"
                            [class.ng-dirty]="lessonForm.get('startDatetime')?.dirty">
                        </p-calendar>
                        <small class="p-error block" *ngIf="isFieldInvalid('startDatetime')">
                            {{ getFieldError('startDatetime') }}
                        </small>
                    </div>

                    <!-- End Date/Time Field -->
                    <div class="col-12 md:col-6 field">
                        <label for="endDatetime" class="font-bold">Fim *</label>
                        <p-calendar
                            id="endDatetime"
                            formControlName="endDatetime"
                            [showIcon]="true"
                            [showTime]="true"
                            dateFormat="dd/mm/yy"
                            [class.ng-invalid]="isFieldInvalid('endDatetime')"
                            [class.ng-dirty]="lessonForm.get('endDatetime')?.dirty">
                        </p-calendar>
                        <small class="p-error block" *ngIf="isFieldInvalid('endDatetime')">
                            {{ getFieldError('endDatetime') }}
                        </small>
                    </div>

                    <!-- Online Lesson Checkbox -->
                    <div class="col-12 field">
                        <div class="flex align-items-center">
                            <label for="online" class="font-bold mr-2">Online Lesson</label>
                            <p-checkbox
                                id="online"
                                formControlName="online"
                                [binary]="true">
                            </p-checkbox>
                        </div>
                    </div>

                    <!-- Online Link Field (conditional) -->
                    <div class="col-12 field" *ngIf="lessonForm.get('online')?.value">
                        <label for="onlineLink" class="font-bold">Online Link</label>
                        <input
                            id="onlineLink"
                            type="text"
                            pInputText
                            formControlName="onlineLink"
                            placeholder="Enter online meeting link">
                    </div>

                    <!-- Status Field -->
                    <div class="col-12 field">
                        <label for="status" class="font-bold">Status</label>
                        <p-dropdown
                            id="status"
                            [options]="statusOptions"
                            formControlName="status"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Select a status">
                        </p-dropdown>
                    </div>

                    <!-- Description Field -->
                    <div class="col-12 field">
                        <label for="description" class="font-bold">Description</label>
                        <textarea
                            id="description"
                            rows="3"
                            pInputTextarea
                            formControlName="description"
                            placeholder="Enter lesson description">
                        </textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-content-end gap-2 mt-4">
                    <button
                        type="button"
                        pButton
                        label="Cancel"
                        icon="pi pi-times"
                        class="p-button-text mr-2"
                        (click)="cancel()">
                    </button>
                    <button
                        type="submit"
                        pButton
                        label="{{(loading$ | async) ? 'Salvando...' : 'Salvar'}}"
                        icon="pi pi-check"
                        [disabled]="lessonForm.invalid">
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
