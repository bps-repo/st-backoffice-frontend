<style>
    .scrollable-content {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .scrollable-content::-webkit-scrollbar {
        width: 6px;
    }

    .scrollable-content::-webkit-scrollbar-track {
        background: var(--surface-100);
        border-radius: 3px;
    }

    .scrollable-content::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 3px;
    }

    .scrollable-content::-webkit-scrollbar-thumb:hover {
        background: var(--surface-400);
    }
</style>

<p-toast></p-toast>

<div class="grid">
    <div class="col-12">
        <div class="flex align-items-center justify-content-between">
            <div>
                <h2 class="m-0">Marcação de Aulas</h2>
                <small class="text-600">Adicione ou remova alunos das aulas disponíveis</small>
            </div>
            <button pButton type="button"
                [label]="savingChanges() ? 'Salvando...' : ('Salvar Alterações' + (enrolled.length ? ' (' + enrolled.length + ' alunos)' : ''))"
                [icon]="savingChanges() ? 'pi pi-spin pi-spinner' : 'pi pi-save'"
                class="p-button-rounded p-button-success" [disabled]="!enrolled.length || savingChanges()"
                (click)="saveChanges()"></button>
        </div>
    </div>

    <!-- Left: lesson list -->
    <div class="col-12 md:col-6">
        <div class="card">
            <div class="flex align-items-center justify-content-between mb-3">
                <h3 class="m-0">Aulas Disponíveis</h3>
            </div>

            <div class="grid mb-3">
                <div class="col-12 md:col-8">
                    <span class="p-input-icon-left w-full">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" class="w-full" placeholder="Buscar aulas..."
                            [formControl]="searchLessonsCtrl" />
                    </span>
                </div>
                <div class="col-12 md:col-4">
                    <p-dropdown [options]="levelOptions" [formControl]="levelFilterCtrl" optionLabel="label"
                        optionValue="value" placeholder="Filtrar por nível" [showClear]="true" class="w-full">
                    </p-dropdown>
                </div>
            </div>

            <div class="flex flex-column gap-2 scrollable-content">
                <div *ngIf="loadingLessons(); else lessonsContent">
                    <div class="flex align-items-center justify-content-center p-4 border-round surface-100">
                        <p-progressSpinner [style]="{'width': '24px', 'height': '24px'}" strokeWidth="4"
                            fill="transparent" animationDuration="1s"></p-progressSpinner>
                        <span class="ml-2 text-600">Carregando aulas...</span>
                    </div>
                    <!-- Skeleton loaders for lessons -->
                    <div class="flex flex-column gap-2 mt-2">
                        <div *ngFor="let i of [1,2,3]" class="p-3 border-round surface-100">
                            <div class="flex align-items-center justify-content-between mb-2">
                                <div class="h-1rem bg-gray-200 border-round w-8"></div>
                                <div class="h-1rem bg-gray-200 border-round w-4"></div>
                            </div>
                            <div class="h-1rem bg-gray-200 border-round w-12 mb-2"></div>
                            <div class="flex gap-2">
                                <div class="h-1rem bg-gray-200 border-round w-6"></div>
                                <div class="h-1rem bg-gray-200 border-round w-8"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <ng-template #lessonsContent>
                    <div *ngFor="let lesson of filteredLessons"
                        class="p-3 border-round surface-100 cursor-pointer hover:surface-200"
                        (click)="selectLesson(lesson)"
                        [ngClass]="{'border-2 border-primary': selectedLesson?.id === lesson.id}">
                        <div class="flex align-items-center justify-content-between">
                            <div class="font-medium">{{ lesson.title }}</div>
                            <span class="p-badge p-badge-success" *ngIf="lesson.status === 'AVAILABLE'">ativa</span>
                        </div>
                        <div class="text-600 mt-1">
                            <i class="pi pi-calendar mr-1"></i>
                            {{ lesson.startDatetime | date:'dd/MM/yyyy HH:mm' }}
                        </div>
                        <div class="mt-2">
                            <span class="p-tag p-tag-rounded mr-2">{{ lesson.unit.name || 'N/A' }}</span>
                            <span class="p-tag p-tag-rounded">{{ lesson.center.name || 'Centro' }}</span>
                        </div>
                        <div class="mt-1 text-xs text-500">
                            <i class="pi pi-user mr-1"></i>
                            {{ lesson.teacher.name || 'Professor não definido' }}
                        </div>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>

    <!-- Right: students panel -->
    <div class="col-12 md:col-6">
        <div class="card">
            <div class="flex align-items-center justify-content-between mb-3">
                <h3 class="m-0">{{ selectedLesson ? 'Alunos para: ' + (selectedLesson.title || '') : 'Selecione uma aula' }}</h3>
            </div>

            <ng-container *ngIf="selectedLesson; else selectLessonHint">
                <span class="p-input-icon-left w-full mb-3">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" class="w-full" placeholder="Buscar alunos..."
                        [formControl]="searchStudentsCtrl" />
                </span>

                <div class="scrollable-content">
                    <!-- Enrolled Students Section -->
                    <div class="mb-2 text-600">Matriculados ({{ enrolled.length }})</div>
                    <div *ngIf="loadingStudents(); else enrolledContent" class="flex flex-column gap-2 mb-3">
                        <div class="flex align-items-center justify-content-center p-4 border-round surface-100">
                            <p-progressSpinner [style]="{'width': '24px', 'height': '24px'}" strokeWidth="4"
                                fill="transparent" animationDuration="1s"></p-progressSpinner>
                            <span class="ml-2 text-600">Carregando alunos matriculados...</span>
                        </div>
                        <!-- Skeleton loaders for enrolled students -->
                        <div class="flex flex-column gap-2">
                            <div *ngFor="let i of [1,2]"
                                class="flex align-items-center justify-content-between p-2 border-round surface-100">
                                <div class="flex-1">
                                    <div class="h-1rem bg-gray-200 border-round w-8 mb-1"></div>
                                    <div class="h-1rem bg-gray-200 border-round w-12"></div>
                                </div>
                                <div class="h-2rem w-2rem bg-gray-200 border-round"></div>
                            </div>
                        </div>
                    </div>
                    <ng-template #enrolledContent>
                        <div class="flex flex-column gap-2 mb-3">
                            <div *ngFor="let s of enrolled"
                                class="flex align-items-center justify-content-between p-2 border-round surface-100">
                                <div>
                                    <div class="font-medium">{{ getStudentName(s) }}</div>
                                    <small class="text-600">{{ getStudentEmail(s) }}</small>
                                </div>
                                <button pButton type="button" icon="pi pi-minus"
                                    class="p-button-rounded p-button-danger p-button-text"
                                    (click)="removeStudent(s)"></button>
                            </div>
                        </div>
                    </ng-template>

                    <!-- Available Students Section -->
                    <div class="mb-2 text-600">Disponíveis ({{ available.length }})</div>
                    <div *ngIf="loadingStudents(); else availableContent">
                        <div class="flex align-items-center justify-content-center p-4 border-round surface-100">
                            <p-progressSpinner [style]="{'width': '24px', 'height': '24px'}" strokeWidth="4"
                                fill="transparent" animationDuration="1s"></p-progressSpinner>
                            <span class="ml-2 text-600">Carregando alunos disponíveis...</span>
                        </div>
                        <!-- Skeleton loaders for available students -->
                        <div class="flex flex-column gap-2">
                            <div *ngFor="let i of [1,2,3]"
                                class="flex align-items-center justify-content-between p-2 border-round surface-100">
                                <div class="flex-1">
                                    <div class="h-1rem bg-gray-200 border-round w-8 mb-1"></div>
                                    <div class="h-1rem bg-gray-200 border-round w-12 mb-1"></div>
                                    <div class="flex gap-1">
                                        <div class="h-1rem bg-gray-200 border-round w-6"></div>
                                        <div class="h-1rem bg-gray-200 border-round w-8"></div>
                                    </div>
                                </div>
                                <div class="h-2rem w-2rem bg-gray-200 border-round"></div>
                            </div>
                        </div>
                    </div>
                    <ng-template #availableContent>
                        <div *ngIf="available.length; else noneAvailable" class="flex flex-column gap-2">
                            <div *ngFor="let s of available"
                                class="flex align-items-center justify-content-between p-2 border-round surface-100">
                                <div>
                                    <div class="font-medium">{{ getAvailableStudentName(s) }}</div>
                                    <small class="text-600">{{ getAvailableStudentEmail(s) }}</small>
                                    <div class="text-xs text-500 mt-1">
                                        <span class="p-tag p-tag-rounded mr-1">{{ s.levelName }}</span>
                                        <span class="p-tag p-tag-rounded">{{ s.centerName }}</span>
                                    </div>
                                </div>
                                <button pButton type="button" icon="pi pi-plus"
                                    class="p-button-rounded p-button-success p-button-text"
                                    (click)="addStudent(s)"></button>
                            </div>
                        </div>
                        <ng-template #noneAvailable>
                            <div class="text-center p-5 text-600">
                                <i class="pi pi-users mb-2 text-3xl text-300"></i>
                                <div>Nenhum aluno disponível para esta aula</div>
                                <small>Todos os alunos compatíveis já estão matriculados</small>
                            </div>
                        </ng-template>
                    </ng-template>
                </div>
            </ng-container>

            <ng-template #selectLessonHint>
                <div class="text-center p-5 text-600">
                    <i class="pi pi-users mb-2 text-3xl text-300"></i>
                    <div>Selecione uma aula</div>
                    <small>Escolha uma aula na lista ao lado para ver os alunos disponíveis</small>
                </div>
            </ng-template>
        </div>
    </div>
</div>
