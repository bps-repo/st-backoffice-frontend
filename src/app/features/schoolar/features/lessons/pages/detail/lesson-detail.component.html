<style>
    ::ng-deep .p-selectbutton {
        display: flex;
        flex-wrap: nowrap;
    }

    ::ng-deep .p-selectbutton .p-button {
        margin-right: 0.5rem;
        border: none;
    }

    ::ng-deep .p-selectbutton .p-button:last-child {
        margin-right: 0;
    }

    /* Animation classes */
    .animate-fade {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .animate-scale {
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
</style>

<div class="lesson-detail-container">
    <!-- Header Section with Navigation -->
    <div class="mb-4">
        <div class="flex align-items-center gap-2 mb-3">
            <p-button icon="pi pi-arrow-left" [text]="true" (click)="goBack()" pTooltip="Voltar">
            </p-button>
            <span class="text-sm text-500">Voltar</span>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading$ | async" class="col-12">
        <div class="card">
            <div class="flex align-items-center justify-content-center p-4">
                <i class="pi pi-spin pi-spinner text-2xl"></i>
                <span class="ml-2">Carregando detalhes da aula...</span>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error$ | async as error" class="col-12">
        <div class="card">
            <div class="flex align-items-center justify-content-center p-4 text-red-600">
                <i class="pi pi-exclamation-triangle text-2xl"></i>
                <span class="ml-2">Erro ao carregar aula: {{ error }}</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="(lesson$ | async) as lesson" class="grid">
        <!-- Title and Action Buttons Section -->
        <div class="col-12">
            <div class="card">
                <div class="flex flex-column md:flex-row justify-content-between align-items-start gap-4">
                    <div class="flex-1">
                        <div class="flex align-items-center gap-3 mb-2">
                            <h1 class="text-3xl font-bold text-900 m-0">{{ lesson.title || 'English Conversation A1' }}
                            </h1>
                        </div>
                        <div class="flex align-items-center gap-3 mb-3">
                            <span class="text-600">{{ lesson.online ? 'Online' : 'Presencial' }} • {{ lesson.center ||
                                'Centro Principal' }}</span>
                            <p-tag [value]="getLessonStatusText(lesson)" [severity]="getLessonStatusSeverity(lesson)"
                                [rounded]="true">
                            </p-tag>
                        </div>
                        <div class="flex align-items-center gap-2 text-600">
                            <i class="pi pi-calendar"></i>
                            <span>{{ lesson.startDatetime | date:'dd/MM/yyyy às HH:mm' }}</span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-2 flex-wrap">
                        <p-button icon="pi pi-copy" label="Duplicar" [outlined]="true" size="small"
                            (click)="duplicateLesson(lesson)">
                        </p-button>
                        <p-button icon="pi pi-pencil" label="Editar" severity="info" size="small"
                            (click)="editLesson(lesson)">
                        </p-button>
                        <p-button icon="pi pi-download" label="Exportar" [outlined]="true" size="small"
                            (click)="exportLesson(lesson)">
                        </p-button>
                        <p-button icon="pi pi-print" label="Imprimir" [outlined]="true" size="small"
                            (click)="printLesson(lesson)">
                        </p-button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards Section -->
        <div class="col-12">
            <div class="grid">
                <div class="col-12 md:col-4">
                    <div class="card text-center border-1 surface-border">
                        <div class="flex align-items-center justify-content-center mb-3">
                            <div
                                class="bg-blue-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center">
                                <i class="pi pi-users text-blue-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-900 m-0 mb-2">
                            <span *ngIf="loadingStudents" class="pi pi-spin pi-spinner"></span>
                            <span *ngIf="!loadingStudents">{{ getStudentCount() }}</span>
                        </h3>
                        <p class="text-600 m-0">Alunos</p>
                    </div>
                </div>
                <div class="col-12 md:col-4">
                    <div class="card text-center border-1 surface-border">
                        <div class="flex align-items-center justify-content-center mb-3">
                            <div
                                class="bg-green-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center">
                                <i class="pi pi-check-circle text-green-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-900 m-0 mb-2">
                            <span *ngIf="loadingAttendances" class="pi pi-spin pi-spinner"></span>
                            <span *ngIf="!loadingAttendances">{{ getAttendanceRate() }}%</span>
                        </h3>
                        <p class="text-600 m-0">Taxa de Presença</p>
                    </div>
                </div>
                <div class="col-12 md:col-4">
                    <div class="card text-center border-1 surface-border">
                        <div class="flex align-items-center justify-content-center mb-3">
                            <div
                                class="bg-purple-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center">
                                <i class="pi pi-book text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-900 m-0 mb-2">
                            <span *ngIf="loadingMaterials" class="pi pi-spin pi-spinner"></span>
                            <span *ngIf="!loadingMaterials">{{ getMaterialCount() }}</span>
                        </h3>
                        <p class="text-600 m-0">Materiais</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="col-12 mt-4">
            <div class="flex justify-content-start gap-2 items-center mb-4">
                <p-selectButton [options]="viewOptions" [(ngModel)]="currentView" (onChange)="onViewChange($event)"
                    optionLabel="label" optionValue="value"></p-selectButton>
            </div>

            <!-- Overview Tab Content -->
            @if (currentView === 'overview') {
            <div class="col-12 animate-scale px-scalein">
                <div class="grid">
                    <!-- Basic Information Card -->
                    <div class="col-12 md:col-6">
                        <div class="card h-full">
                            <h3 class="text-xl font-semibold text-900 mb-4">Informações Básicas</h3>
                            <div class="grid">
                                <div class="col-12">
                                    <div class="field">
                                        <label class="block text-sm font-medium text-600 mb-1">TIPO</label>
                                        <p class="text-900 font-semibold m-0">{{ lesson.online ? 'Online' : 'Presencial'
                                            }}</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="field">
                                        <label class="block text-sm font-medium text-600 mb-1">CENTRO</label>
                                        <p class="text-900 font-semibold m-0">{{ lesson.center || 'Centro Principal' }}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="field">
                                        <label class="block text-sm font-medium text-600 mb-1">NÍVEL</label>
                                        <p class="text-900 font-semibold m-0">{{ lesson.level || 'A1' }}</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="field">
                                        <label class="block text-sm font-medium text-600 mb-1">TURMA</label>
                                        <p class="text-900 font-semibold m-0">{{ lesson.unit || 'Turma A' }}</p>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="field">
                                        <label class="block text-sm font-medium text-600 mb-1">PROFESSOR</label>
                                        <div class="flex align-items-center gap-2">
                                            <div
                                                class="bg-blue-100 border-circle w-2rem h-2rem flex align-items-center justify-content-center">
                                                <span class="text-blue-600 font-semibold text-sm">{{
                                                    getTeacherInitials(lesson) }}</span>
                                            </div>
                                            <span class="text-900 font-semibold">{{ lesson.teacher || 'Prof. Maria
                                                Silva' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Online Access Card -->
                    <div class="col-12 md:col-6">
                        <div class="card h-full">
                            <h3 class="text-xl font-semibold text-900 mb-4">Acesso Online</h3>
                            <div class="text-center py-4">
                                <div class="mb-4">
                                    <i class="pi pi-video text-6xl text-300"></i>
                                </div>
                                <p class="text-600 mb-4">{{ lesson.online ? 'Link de aula online configurado' : 'Nenhum
                                    link de aula online configurado' }}</p>
                                <p-button *ngIf="lesson.online && lesson.onlineLink" label="Acessar Aula"
                                    icon="pi pi-external-link" severity="info" (click)="openOnlineLink(lesson)">
                                </p-button>
                                <p-button *ngIf="!lesson.online || !lesson.onlineLink" label="Configurar Link"
                                    icon="pi pi-cog" [outlined]="true" severity="secondary"
                                    (click)="configureOnlineLink(lesson)">
                                </p-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="col-12 mt-4">
                    <div class="card">
                        <h3 class="text-xl font-semibold text-900 mb-4">Ações Rápidas</h3>
                        <div class="grid">
                            <div class="col-6 md:col-2">
                                <div class="text-center cursor-pointer p-3 border-round hover:surface-100 transition-colors"
                                    (click)="markAttendance()">
                                    <div
                                        class="bg-blue-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-check text-blue-600 text-xl"></i>
                                    </div>
                                    <p class="text-900 font-medium text-sm m-0">Marcar Presença</p>
                                </div>
                            </div>
                            <div class="col-6 md:col-2">
                                <div class="text-center cursor-pointer p-3 border-round hover:surface-100 transition-colors"
                                    (click)="addMaterial(lesson)">
                                    <div
                                        class="bg-green-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-plus-circle text-green-600 text-xl"></i>
                                    </div>
                                    <p class="text-900 font-medium text-sm m-0">Adicionar Material</p>
                                </div>
                            </div>
                            <div class="col-6 md:col-2">
                                <div class="text-center cursor-pointer p-3 border-round hover:surface-100 transition-colors"
                                    (click)="addNote()">
                                    <div
                                        class="bg-orange-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-file-edit text-orange-600 text-xl"></i>
                                    </div>
                                    <p class="text-900 font-medium text-sm m-0">Fazer Anotação</p>
                                </div>
                            </div>
                            <div class="col-6 md:col-2">
                                <div class="text-center cursor-pointer p-3 border-round hover:surface-100 transition-colors"
                                    (click)="rescheduleLesson()">
                                    <div
                                        class="bg-purple-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-clock text-purple-600 text-xl"></i>
                                    </div>
                                    <p class="text-900 font-medium text-sm m-0">Reagendar Aula</p>
                                </div>
                            </div>
                            <div class="col-6 md:col-2">
                                <div class="text-center cursor-pointer p-3 border-round hover:surface-100 transition-colors"
                                    (click)="cancelLesson()">
                                    <div
                                        class="bg-red-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-times text-red-600 text-xl"></i>
                                    </div>
                                    <p class="text-900 font-medium text-sm m-0">Cancelar Aula</p>
                                </div>
                            </div>
                            <div class="col-6 md:col-2">
                                <div class="text-center cursor-pointer p-3 border-round hover:surface-100 transition-colors"
                                    (click)="sendNotification()">
                                    <div
                                        class="bg-cyan-100 border-circle w-3rem h-3rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-send text-cyan-600 text-xl"></i>
                                    </div>
                                    <p class="text-900 font-medium text-sm m-0">Enviar Notificação</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- Students Tab Content -->
            @if (currentView === 'students') {
            <div class="col-12 animate-scale px-scalein">
                <div class="card">
                    <div class="flex justify-content-between align-items-center mb-4">
                        <h3 class="text-xl font-semibold text-900 m-0">Lista de Alunos ({{ getStudentCount() }})</h3>
                        <p-button icon="pi pi-plus" label="Adicionar Aluno" size="small" (click)="addStudent()">
                        </p-button>
                    </div>

                    <div *ngIf="loadingStudents" class="flex align-items-center justify-content-center p-4">
                        <i class="pi pi-spin pi-spinner text-xl"></i>
                        <span class="ml-2">Carregando alunos...</span>
                    </div>

                    <div *ngIf="!loadingStudents && students.length > 0" class="space-y-3">
                        <div *ngFor="let student of students"
                            class="flex align-items-center gap-3 p-3 border-round surface-100">
                            <div
                                class="bg-blue-100 border-circle w-2rem h-2rem flex align-items-center justify-content-center">
                                <span class="text-blue-600 font-semibold text-sm">
                                    {{ student.user.firstname[0] }}{{ student.user.lastname[0] }}
                                </span>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-900 m-0">{{ student.user.firstname }} {{
                                    student.user.lastname }}</p>
                                <p class="text-sm text-600 m-0">{{ student.user.email }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-600 m-0">Progresso</p>
                                <p class="font-semibold text-900 m-0">{{ student.levelProgressPercentage }}%</p>
                            </div>
                            <div class="flex gap-2">
                                <p-button icon="pi pi-eye" [text]="true" size="small" pTooltip="Ver detalhes"
                                    (click)="viewStudentDetails(student)">
                                </p-button>
                                <p-button icon="pi pi-pencil" [text]="true" size="small" pTooltip="Editar"
                                    (click)="editStudent(student)">
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="!loadingStudents && students.length === 0" class="text-center p-4">
                        <i class="pi pi-users text-3xl text-300 mb-2"></i>
                        <p class="text-600 m-0">Nenhum aluno inscrito nesta aula</p>
                    </div>
                </div>
            </div>
            }

            <!-- Attendance Tab Content -->
            @if (currentView === 'attendance') {
            <div class="col-12 animate-scale px-scalein">
                <div class="card">
                    <div class="flex justify-content-between align-items-center mb-4">
                        <h3 class="text-xl font-semibold text-900 m-0">Controle de Presença</h3>
                        <p-button icon="pi pi-check" label="Marcar Todos Presentes" size="small"
                            (click)="markAllPresent()">
                        </p-button>
                    </div>

                    <div *ngIf="loadingAttendances" class="flex align-items-center justify-content-center p-4">
                        <i class="pi pi-spin pi-spinner text-xl"></i>
                        <span class="ml-2">Carregando presenças...</span>
                    </div>

                    <div *ngIf="!loadingAttendances" class="grid">
                        <div class="col-12">
                            <p-table [value]="getAttendanceTableData()" [tableStyle]="{'min-width': '50rem'}"
                                styleClass="p-datatable-sm">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Aluno</th>
                                        <th>Status</th>
                                        <th>Observações</th>
                                        <th>Ações</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-attendance>
                                    <tr>
                                        <td>
                                            <div class="flex align-items-center gap-2">
                                                <div
                                                    class="bg-blue-100 border-circle w-2rem h-2rem flex align-items-center justify-content-center">
                                                    <span class="text-blue-600 font-semibold text-sm">
                                                        {{ attendance.student.user.firstname[0] }}{{
                                                        attendance.student.user.lastname[0] }}
                                                    </span>
                                                </div>
                                                <span class="font-semibold">{{ attendance.student.user.firstname }} {{
                                                    attendance.student.user.lastname }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <p-tag [value]="attendance.present ? 'Presente' : 'Ausente'"
                                                [severity]="attendance.present ? 'success' : 'danger'" [rounded]="true">
                                            </p-tag>
                                        </td>
                                        <td>
                                            <span class="text-600">{{ attendance.observations || '-' }}</span>
                                        </td>
                                        <td>
                                            <div class="flex gap-2">
                                                <p-button icon="pi pi-pencil" [text]="true" size="small"
                                                    pTooltip="Editar presença" (click)="editAttendance(attendance)">
                                                </p-button>
                                            </div>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                </div>
            </div>
            }

            <!-- Materials Tab Content -->
            @if (currentView === 'materials') {
            <div class="col-12 animate-scale px-scalein">
                <div class="card">
                    <div class="flex justify-content-between align-items-center mb-4">
                        <h3 class="text-xl font-semibold text-900 m-0">Materiais da Aula</h3>
                        <p-button icon="pi pi-plus" label="Adicionar Material" size="small"
                            (click)="addMaterial(lesson)">
                        </p-button>
                    </div>

                    <div *ngIf="loadingMaterials" class="flex align-items-center justify-content-center p-4">
                        <i class="pi pi-spin pi-spinner text-xl"></i>
                        <span class="ml-2">Carregando materiais...</span>
                    </div>

                    <div *ngIf="!loadingMaterials && materials.length > 0" class="space-y-3">
                        <div *ngFor="let material of materials"
                            class="flex align-items-center gap-3 p-3 border-round surface-100">
                            <div
                                class="bg-purple-100 border-circle w-2rem h-2rem flex align-items-center justify-content-center">
                                <i class="pi pi-file text-purple-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-900 m-0">{{ material.title }}</p>
                                <p class="text-sm text-600 m-0">{{ material.description }}</p>
                                <p class="text-xs text-500 m-0">Tipo: {{ material.type }}</p>
                            </div>
                            <div class="flex gap-2">
                                <p-button icon="pi pi-download" [text]="true" size="small" pTooltip="Baixar material"
                                    (click)="downloadMaterial(material)">
                                </p-button>
                                <p-button icon="pi pi-pencil" [text]="true" size="small" pTooltip="Editar material"
                                    (click)="editMaterial(material)">
                                </p-button>
                                <p-button icon="pi pi-trash" [text]="true" size="small" severity="danger"
                                    pTooltip="Remover material" (click)="removeMaterial(material)">
                                </p-button>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="!loadingMaterials && materials.length === 0" class="text-center p-4">
                        <i class="pi pi-book text-3xl text-300 mb-2"></i>
                        <p class="text-600 m-0">Nenhum material disponível</p>
                    </div>
                </div>
            </div>
            }

            <!-- Notes Tab Content -->
            @if (currentView === 'notes') {
            <div class="col-12 animate-scale px-scalein">
                <div class="card">
                    <div class="flex justify-content-between align-items-center mb-4">
                        <h3 class="text-xl font-semibold text-900 m-0">Anotações da Aula</h3>
                        <p-button icon="pi pi-plus" label="Nova Anotação" size="small" (click)="addNote()">
                        </p-button>
                    </div>

                    <div *ngIf="notes.length > 0" class="space-y-3">
                        <div *ngFor="let note of notes" class="p-3 border-round surface-100">
                            <div class="flex justify-content-between align-items-start mb-2">
                                <div class="flex align-items-center gap-2">
                                    <div
                                        class="bg-orange-100 border-circle w-2rem h-2rem flex align-items-center justify-content-center">
                                        <i class="pi pi-file-edit text-orange-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-900 m-0">{{ note.title }}</p>
                                        <p class="text-sm text-600 m-0">{{ note.createdAt | date:'dd/MM/yyyy HH:mm' }}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <p-button icon="pi pi-pencil" [text]="true" size="small" pTooltip="Editar anotação"
                                        (click)="editNote(note)">
                                    </p-button>
                                    <p-button icon="pi pi-trash" [text]="true" size="small" severity="danger"
                                        pTooltip="Remover anotação" (click)="removeNote(note)">
                                    </p-button>
                                </div>
                            </div>
                            <p class="text-600 m-0">{{ note.content }}</p>
                        </div>
                    </div>

                    <div *ngIf="notes.length === 0" class="text-center p-4">
                        <i class="pi pi-file-edit text-3xl text-300 mb-2"></i>
                        <p class="text-600 m-0">Nenhuma anotação disponível</p>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>
