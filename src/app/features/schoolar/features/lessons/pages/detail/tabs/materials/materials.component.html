<p-toast></p-toast>

<div class="card">
    <div *ngIf="lessonItem" class="grid">
        <div class="col-12">
            <p-card>
                <ng-template pTemplate="title">
                    <div class="flex justify-content-between align-items-center">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-book text-primary"></i>
                            <span class="font-bold">Lesson Materials</span>
                        </div>
                        <div class="flex gap-2">
                            <button pButton pRipple label="Add Material" icon="pi pi-plus" class="p-button-sm" (click)="showAddMaterialDialog()"></button>
                            <button pButton pRipple label="Advanced Add" icon="pi pi-plus-circle" class="p-button-sm p-button-outlined" (click)="navigateToAddMaterial()"></button>
                        </div>
                    </div>
                </ng-template>

                <p-table [value]="materials" [tableStyle]="{'min-width': '50rem'}" [paginator]="true" [rows]="5"
                         styleClass="p-datatable-sm p-datatable-gridlines" [showCurrentPageReport]="true"
                         currentPageReportTemplate="Showing {first} to {last} of {totalRecords} materials">
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 3rem"></th>
                            <th pSortableColumn="title">Title <p-sortIcon field="title"></p-sortIcon></th>
                            <th pSortableColumn="type">Type <p-sortIcon field="type"></p-sortIcon></th>
                            <th pSortableColumn="uploadDate">Upload Date <p-sortIcon field="uploadDate"></p-sortIcon></th>
                            <th pSortableColumn="uploader.name">Uploader <p-sortIcon field="uploader.name"></p-sortIcon></th>
                            <th style="width: 8rem">Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-material>
                        <tr>
                            <td>
                                <i [class]="getMaterialTypeIcon(material.type)" class="text-xl"></i>
                            </td>
                            <td>
                                <div class="font-medium">{{ material.title }}</div>
                                <div class="text-sm text-500">{{ material.description }}</div>
                            </td>
                            <td>
                                <p-tag [value]="material.type" [severity]="material.active ? 'success' : 'danger'"></p-tag>
                            </td>
                            <td>{{ formatDate(material.uploadDate) }}</td>
                            <td>{{ material.uploader?.name }}</td>
                            <td>
                                <div class="flex gap-2 justify-content-center">
                                    <button pButton pRipple icon="pi pi-download" class="p-button-rounded p-button-text"
                                            pTooltip="Download" tooltipPosition="top" (click)="downloadMaterial(material)"></button>
                                    <button pButton pRipple icon="pi pi-eye" class="p-button-rounded p-button-text p-button-info"
                                            pTooltip="Preview" tooltipPosition="top"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="6" class="text-center p-4">
                                <div class="flex flex-column align-items-center">
                                    <i class="pi pi-folder-open text-500" style="font-size: 3rem"></i>
                                    <span class="text-700 my-2">No materials found</span>
                                    <span class="text-500 text-sm mb-3">Add materials to this lesson to make them available to students</span>
                                    <div class="flex gap-2 justify-content-center">
                                        <button pButton pRipple label="Quick Add" icon="pi pi-plus" class="p-button-sm" (click)="showAddMaterialDialog()"></button>
                                        <button pButton pRipple label="Advanced Add" icon="pi pi-plus-circle" class="p-button-sm p-button-outlined" (click)="navigateToAddMaterial()"></button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>
    </div>
</div>

<!-- Add Material Dialog -->
<p-dialog [(visible)]="displayAddDialog" [style]="{width: '450px'}" header="Add New Material" [modal]="true" styleClass="p-fluid">
    <div class="field">
        <label for="title">Title</label>
        <input type="text" pInputText id="title" [(ngModel)]="newMaterial.title" required autofocus />
    </div>
    <div class="field">
        <label for="description">Description</label>
        <textarea pInputTextarea id="description" [(ngModel)]="newMaterial.description" rows="3"></textarea>
    </div>
    <div class="field">
        <label for="type">Type</label>
        <input type="text" pInputText id="type" [(ngModel)]="newMaterial.type" required />
        <small class="text-500">e.g., pdf, doc, ppt, mp4, etc.</small>
    </div>
    <div class="field">
        <label for="fileUpload">Upload File</label>
        <p-fileUpload id="fileUpload" mode="basic" chooseLabel="Choose File" [auto]="true"
            accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.mp4,.mp3"
            [maxFileSize]="10000000"
            (onSelect)="onFileSelect($event)"
            (onError)="onFileUploadError($event)">
        </p-fileUpload>
        <small class="text-500">Max file size: 10MB</small>
    </div>
    <div class="field">
        <label for="fileUrl">File URL</label>
        <input type="text" pInputText id="fileUrl" [(ngModel)]="newMaterial.fileUrl" required />
        <small class="text-500">Enter a URL or upload a file above</small>
    </div>
    <div class="grid">
        <div class="col-6">
            <div class="field">
                <label for="startDate">Available From</label>
                <p-calendar id="startDate" [(ngModel)]="newMaterial.availabilityStartDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
            </div>
        </div>
        <div class="col-6">
            <div class="field">
                <label for="endDate">Available Until</label>
                <p-calendar id="endDate" [(ngModel)]="newMaterial.availabilityEndDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
            </div>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideAddMaterialDialog()"></button>
        <button pButton pRipple label="Save" icon="pi pi-check" class="p-button-text" (click)="addMaterial()"></button>
    </ng-template>
</p-dialog>
