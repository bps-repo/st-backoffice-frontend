<style>
    ::ng-deep .p-selectbutton {
        display: flex;
        flex-wrap: nowrap;
    }

    ::ng-deep .p-selectbutton .p-button {
        margin-right: 0.5rem;
        border: none;
    }

    ::ng-deep .p-selectbutton .p-button:last-child {
        margin-right: 0;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 100;
        padding-top: 1rem;
        padding-bottom: 1rem;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .sticky-active {
        background-color: var(--surface-card);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Animation classes */
    .animate-fade {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .animate-scale {
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    /* For elements that need to stick to the top */
    .content-sticky {
        position: sticky;
        top: 140px; /* Adjust based on header height */
        z-index: 90;
    }
</style>

<section class="grid">

    <div #mainHeader id="mainHeader" class="col-12 flex justify-content-between items-center mb-4 sticky-header"
         [ngClass]="{'sticky-active': isMainHeaderSticky}">
        <div>
            <h2 class="font-bold text-2xl mb-4">Gest√£o de alunos</h2>
            <span class="text-lg">Cadastro e acompanhamento completo dos alunos</span>
        </div>
        <p-button
            (onClick)="navigateToCreateStudent()"
            label="Inscrever Aluno"
            icon="pi pi-plus"
            class="p-button-outlined"
        ></p-button>
    </div>

    <div #viewSelector id="viewSelector" class="col-12 flex justify-content-start gap-2 items-center mb-4 sticky-header"
         style="top: 80px;" [ngClass]="{'sticky-active': isViewSelectorSticky}">
        <p-selectButton [options]="viewOptions" [(ngModel)]="currentView" (onChange)="onViewChange($event)"
                        optionLabel="label" optionValue="value"></p-selectButton>
    </div>

    <!-- KPI Cards - only visible in list view with smooth animation -->
    @if (currentView === 'list') {
        @if (kpis$ | async; as kpis) {
            @for (k of kpis; track k) {
                <div [ngClass]="'col-12 md:col-6 xl:col-' + Math.floor(12 / kpis.length)"
                     class="animate-fade px-fadein">
                    <app-kpi-indicators class="w-full h-full" [kpi]="k"></app-kpi-indicators>
                </div>
            }
        }
    }

    <!-- List View -->
    @if (currentView === 'list') {
        <div class="col-12 animate-fade px-fadein">
            <div class="card">
                <div class="flex gap-2 align-items-center">
                    <input
                        pInputText
                        type="text"
                        class="w-full"
                        placeholder="Buscar por nome, email, estado"
                    />
                    <button pButton type="button" label="Filtrar"></button>
                </div>
            </div>
        </div>

        <!-- Student Table -->
        <app-global-table
            tableLabel="Alunos"
            [headerActions]="headerActions"
            [data]="(students$ | async)!"
            [entity]="'students'"
            [columns]="columns"
            [globalFilterFields]="globalFilterFields"
            [columnTemplates]="customTemplates"
            (rowSelect)="onRowSelect($event)"
            (createEntity)="navigateToCreateStudent()"
            class="w-full animate-fade px-fadein"
        ></app-global-table>
    }

    <!-- Dashboard View - appears with scale animation and sticks below headers -->
    @if (currentView === 'dashboard') {
        <div class="col-12 animate-scale px-scalein content-sticky">
            <app-students></app-students>
        </div>
    }

    <!-- Reports View - appears with scale animation and sticks below headers -->
    @if (currentView === 'reports') {
        <div class="col-12 animate-scale px-scalein content-sticky">
            <app-student-report></app-student-report>
        </div>
    }
</section>


<!-- Name template field -->
<ng-template #nameTemplate let-rowData>
    <span>{{ rowData.user.firstname + " " + rowData.user.lastname }}   </span>
</ng-template>

<ng-template #phoneTemplate let-rowData>
    <span> {{ rowData.user.phone ?? 'N/A' }} </span>
</ng-template>

<ng-template #emailTemplate let-rowData>
    <span>{{ rowData.user.email }}</span>
</ng-template>


<ng-template #dateOfBirthTemplate let-rowData>
    <span>{{ rowData.user.birthdate ?? 'N/A' }}</span>
</ng-template>

<ng-template #centerTemplate let-rowData>
    <span>{{ getStudentCenter(rowData.centerId) }}</span>
</ng-template>

<ng-template #levelTemplate let-rowData>
    <span> {{ getStudentLevel(rowData.levelId) }} </span>
</ng-template>

<ng-template #classTemplate let-rowData>
    <span> {{ rowData.studentClass?.name ?? 'N/A' }} </span>
</ng-template>

<ng-template #statusTemplate let-rowData>
    <p-badge
        [value]="rowData.status === 'ACTIVE' ? 'Ativo' : 'Inativo'"
        [severity]="rowData.status === 'ACTIVE' ? 'success' : 'danger'"
        class="w-full"
    ></p-badge>
</ng-template>

<ng-template #typeTemplate let-rowData>
    <p-badge
        [value]="rowData.vip ? 'VIP' : 'STANDARD'"
        [severity]="rowData.vip ? 'warning' : 'info'"
        class="w-full"
    ></p-badge>
</ng-template>

<ng-template #actionsTemplate let-center>
    <div class="flex gap-2 justify-content-center">
        <button
            pButton
            pRipple
            icon="pi pi-eye"
            class="p-button-rounded p-button-text"
            (click)="navigateToEditStudent(center)"
            pTooltip="Ver Detalhes"
            tooltipPosition="top"
        ></button>
    </div>
</ng-template>
